name: Validate Dashboards

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master
      - develop

jobs:
  validate-json:
    name: Validate JSON Syntax
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate JSON files
        run: |
          echo "Validating JSON files..."
          ERRORS=0
          for file in $(find dashboards -name "*.json"); do
            echo "Checking $file..."
            if ! jq empty "$file" 2>/dev/null; then
              echo "❌ Invalid JSON: $file"
              ERRORS=$((ERRORS + 1))
            else
              echo "✅ Valid JSON: $file"
            fi
          done
          
          if [ $ERRORS -gt 0 ]; then
            echo "❌ Found $ERRORS invalid JSON file(s)"
            exit 1
          fi
          echo "✅ All JSON files are valid"
  
  validate-dashboards:
    name: Validate Dashboard Schema
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check dashboard structure
        run: |
          echo "Checking dashboard structure..."
          ERRORS=0
          for file in $(find dashboards -name "*.json"); do
            echo "Checking structure of $file..."
            
            # Check for required fields
            if ! jq -e '.title' "$file" >/dev/null 2>&1; then
              echo "❌ Missing 'title' field in $file"
              ERRORS=$((ERRORS + 1))
            fi
            
            if ! jq -e '.panels or .rows' "$file" >/dev/null 2>&1; then
              echo "❌ Missing 'panels' or 'rows' field in $file"
              ERRORS=$((ERRORS + 1))
            fi
            
            if ! jq -e '.templating' "$file" >/dev/null 2>&1; then
              echo "⚠️  Warning: Missing 'templating' field in $file"
            fi
          done
          
          if [ $ERRORS -gt 0 ]; then
            echo "❌ Found $ERRORS dashboard(s) with structural issues"
            exit 1
          fi
          echo "✅ All dashboards have valid structure"
  
  validate-yaml:
    name: Validate YAML Files
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate YAML files
        run: |
          echo "Installing yamllint..."
          pip install yamllint
          
          echo "Validating YAML files..."
          yamllint -d "{extends: default, rules: {line-length: {max: 120}}}" \
            examples/ kustomization.yaml || true
  
  test-kustomize:
    name: Test Kustomize Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: "5.0.0"
      
      - name: Test Kustomize build
        run: |
          echo "Testing Kustomize build..."
          kustomize build . > /tmp/output.yaml
          echo "✅ Kustomize build successful"
          
          echo "Generated resources:"
          grep -E "^kind:" /tmp/output.yaml | sort | uniq -c
