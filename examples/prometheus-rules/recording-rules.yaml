apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: kubernetes-recording-rules
  namespace: monitoring
  labels:
    prometheus: kube-prometheus
    role: recording-rules
spec:
  groups:
    - name: kubernetes.namespace.rules
      interval: 30s
      rules:
        # Namespace CPU usage
        - record: namespace:container_cpu_usage:sum
          expr: |
            sum by (namespace, cluster) (
              rate(container_cpu_usage_seconds_total{container!="",image!=""}[5m])
            )
        
        # Namespace memory usage
        - record: namespace:container_memory_usage:sum
          expr: |
            sum by (namespace, cluster) (
              container_memory_working_set_bytes{container!="",image!=""}
            )
        
        # Namespace network receive bytes
        - record: namespace:container_network_receive_bytes:sum
          expr: |
            sum by (namespace, cluster) (
              rate(container_network_receive_bytes_total[5m])
            )
        
        # Namespace network transmit bytes
        - record: namespace:container_network_transmit_bytes:sum
          expr: |
            sum by (namespace, cluster) (
              rate(container_network_transmit_bytes_total[5m])
            )
    
    - name: kubernetes.pod.rules
      interval: 30s
      rules:
        # Pod CPU usage
        - record: pod:container_cpu_usage:sum
          expr: |
            sum by (namespace, pod, cluster) (
              rate(container_cpu_usage_seconds_total{container!="",image!=""}[5m])
            )
        
        # Pod memory usage
        - record: pod:container_memory_usage:sum
          expr: |
            sum by (namespace, pod, cluster) (
              container_memory_working_set_bytes{container!="",image!=""}
            )
        
        # Pod CPU requests
        - record: pod:kube_pod_container_resource_requests_cpu_cores:sum
          expr: |
            sum by (namespace, pod, cluster) (
              kube_pod_container_resource_requests{resource="cpu"}
            )
        
        # Pod memory requests
        - record: pod:kube_pod_container_resource_requests_memory_bytes:sum
          expr: |
            sum by (namespace, pod, cluster) (
              kube_pod_container_resource_requests{resource="memory"}
            )
    
    - name: kubernetes.cluster.rules
      interval: 30s
      rules:
        # Cluster CPU usage
        - record: cluster:cpu_usage:rate5m
          expr: |
            sum(rate(container_cpu_usage_seconds_total{container!="",image!=""}[5m]))
        
        # Cluster memory usage
        - record: cluster:memory_usage:bytes
          expr: |
            sum(container_memory_working_set_bytes{container!="",image!=""})
        
        # Cluster CPU capacity
        - record: cluster:cpu_capacity:sum
          expr: |
            sum(kube_node_status_capacity{resource="cpu"})
        
        # Cluster memory capacity
        - record: cluster:memory_capacity:sum
          expr: |
            sum(kube_node_status_capacity{resource="memory"})
        
        # Cluster CPU utilization percentage
        - record: cluster:cpu_utilization:ratio
          expr: |
            cluster:cpu_usage:rate5m / cluster:cpu_capacity:sum
        
        # Cluster memory utilization percentage
        - record: cluster:memory_utilization:ratio
          expr: |
            cluster:memory_usage:bytes / cluster:memory_capacity:sum
    
    - name: kubernetes.node.rules
      interval: 30s
      rules:
        # Node CPU usage
        - record: node:cpu_usage:rate5m
          expr: |
            sum by (node, cluster) (
              rate(container_cpu_usage_seconds_total{id="/"}[5m])
            )
        
        # Node memory usage
        - record: node:memory_usage:bytes
          expr: |
            sum by (node, cluster) (
              container_memory_working_set_bytes{id="/"}
            )
        
        # Node filesystem usage
        - record: node:filesystem_usage:ratio
          expr: |
            sum by (node, cluster) (
              container_fs_usage_bytes{id="/"}
            ) 
            /
            sum by (node, cluster) (
              container_fs_limit_bytes{id="/"}
            )
